{% extends 'base_public.html' %}
{% load widget_tweaks %}

{% block title %}Book {{ room_type.name }} - {{ request.tenant.name|default:"Luxury Hotel" }}{% endblock %}

{% block content %}
<!-- Header -->
<div class="bg-dark-900 py-20 relative overflow-hidden">
    <div class="absolute inset-0 opacity-20">
        <img src="https://images.unsplash.com/photo-1618773928121-c32242e63f39?q=80&w=2070&auto=format&fit=crop" alt="Background" class="w-full h-full object-cover">
    </div>
    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <p class="text-gold-400 font-sans text-xs tracking-[0.3em] uppercase mb-4 animate-fade-in-up">Reservation</p>
        <h1 class="font-serif text-4xl md:text-5xl text-white mb-4 animate-fade-in-up delay-100">Secure Your Stay</h1>
    </div>
</div>

<div class="min-h-screen bg-gray-50 py-16 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
        <!-- Room Summary Card -->
        <div class="bg-white p-6 md:p-8 shadow-xl shadow-gray-200/50 mb-8 border-t-4 border-gold-500 animate-fade-in-up delay-200">
            <div class="flex flex-col md:flex-row items-center gap-8">
                <div class="w-full md:w-1/3 aspect-[4/3] relative overflow-hidden">
                    {% if room_type.image %}
                        <img src="{{ room_type.image.url }}" alt="{{ room_type.name }}" class="w-full h-full object-cover">
                    {% else %}
                        <img src="https://images.unsplash.com/photo-1611892440504-42a792e24d32?q=80&w=2070&auto=format&fit=crop" class="w-full h-full object-cover">
                    {% endif %}
                </div>
                <div class="w-full md:w-2/3 text-center md:text-left">
                    <h2 class="font-serif text-3xl text-dark-900 mb-2">{{ room_type.name }}</h2>
                    <p class="text-gray-500 font-light mb-4">{{ room_type.description|truncatechars:150 }}</p>
                    <div class="inline-flex items-center px-4 py-2 bg-gray-100 text-dark-900 font-serif italic text-lg">
                        {{ site_settings.currency_symbol }}{{ room_type.price_per_night }} <span class="text-xs font-sans text-gray-400 not-italic uppercase tracking-wider ml-2">/ Night</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking Form -->
        <div class="bg-white shadow-xl shadow-gray-200/50 p-8 md:p-12 animate-fade-in-up delay-300">
            <form method="POST" class="space-y-12">
                {% csrf_token %}
                
                <!-- Dates Section -->
                <div>
                    <h3 class="font-serif text-2xl text-dark-900 mb-8 flex items-center gap-3">
                        <span class="w-8 h-8 rounded-full bg-gold-100 text-gold-600 flex items-center justify-center text-sm font-bold font-sans">1</span>
                        Dates & Preference
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <label for="id_check_in_date" class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Check-in Date</label>
                            {% render_field form.check_in_date class="w-full bg-gray-50 border-none p-4 text-dark-900 font-sans focus:ring-1 focus:ring-gold-500 transition-colors cursor-pointer" %}
                            {% if form.check_in_date.errors %}
                                <p class="text-red-500 text-xs mt-2">{{ form.check_in_date.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label for="id_check_out_date" class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Check-out Date</label>
                            {% render_field form.check_out_date class="w-full bg-gray-50 border-none p-4 text-dark-900 font-sans focus:ring-1 focus:ring-gold-500 transition-colors cursor-pointer" %}
                            {% if form.check_out_date.errors %}
                                <p class="text-red-500 text-xs mt-2">{{ form.check_out_date.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="md:col-span-2 hidden" id="room-selection-container">
                            <label for="selected_room" class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">
                                Select Specific Room (Found <span id="available-count">0</span>)
                            </label>
                            <select name="selected_room" id="selected_room" class="w-full bg-gray-50 border-none p-4 text-dark-900 font-sans focus:ring-1 focus:ring-gold-500 transition-colors cursor-pointer appearance-none">
                                <option value="">Auto-assign best available room</option>
                            </select>
                            <p class="mt-2 text-xs text-gray-400 italic">
                                If you don't select a room, we will assign the best one for your dates.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Guest Info -->
                <div class="border-t border-gray-100 pt-12">
                    <h3 class="font-serif text-2xl text-dark-900 mb-8 flex items-center gap-3">
                        <span class="w-8 h-8 rounded-full bg-gold-100 text-gold-600 flex items-center justify-center text-sm font-bold font-sans">2</span>
                        Guest Details
                    </h3>
                    
                    {% if not user.is_authenticated %}
                    <div class="mb-8 p-6 bg-blue-50/50 border border-blue-100">
                        <p class="text-sm text-blue-800 leading-relaxed">
                            <span class="font-bold">Note:</span> An account will be automatically created for you. 
                            You can use your <span class="font-bold">Email</span> to access your booking details later.
                        </p>
                    </div>
                    {% endif %}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <label for="id_first_name" class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">First Name</label>
                            {% render_field form.first_name class="w-full bg-gray-50 border-none p-4 text-dark-900 font-sans focus:ring-1 focus:ring-gold-500 transition-colors" placeholder="e.g. John" %}
                            {% if form.first_name.errors %}
                                <p class="text-red-500 text-xs mt-2">{{ form.first_name.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label for="id_last_name" class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Last Name</label>
                            {% render_field form.last_name class="w-full bg-gray-50 border-none p-4 text-dark-900 font-sans focus:ring-1 focus:ring-gold-500 transition-colors" placeholder="e.g. Doe" %}
                            {% if form.last_name.errors %}
                                <p class="text-red-500 text-xs mt-2">{{ form.last_name.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Render hidden guest_name -->
                        {{ form.guest_name }}

                        <div>
                            <label for="id_guest_email" class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Email Address</label>
                            {% render_field form.guest_email class="w-full bg-gray-50 border-none p-4 text-dark-900 font-sans focus:ring-1 focus:ring-gold-500 transition-colors" placeholder="john@example.com" %}
                            {% if form.guest_email.errors %}
                                <p class="text-red-500 text-xs mt-2">{{ form.guest_email.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label for="id_guest_phone" class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Phone Number</label>
                            {% render_field form.guest_phone class="w-full bg-gray-50 border-none p-4 text-dark-900 font-sans focus:ring-1 focus:ring-gold-500 transition-colors" placeholder="+1 (555) 000-0000" %}
                            {% if form.guest_phone.errors %}
                                <p class="text-red-500 text-xs mt-2">{{ form.guest_phone.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="pt-8 flex flex-col md:flex-row items-center justify-between gap-6">
                    <div class="text-center md:text-left">
                        <p class="text-xs text-gray-400 mb-1">Total Amount</p>
                        <p class="text-2xl font-serif text-dark-900" id="estimated-total">Calculated at checkout</p>
                    </div>
                    
                    <div class="flex items-center gap-4 w-full md:w-auto">
                        <a href="{% url 'room_detail' room_type.pk %}" class="flex-1 md:flex-none text-center px-8 py-4 border border-gray-200 text-xs font-bold uppercase tracking-widest text-gray-500 hover:bg-gray-50 hover:text-dark-900 transition-colors">
                            Cancel
                        </a>
                        <button type="submit" class="flex-1 md:flex-none px-10 py-4 bg-gold-500 hover:bg-gold-600 text-white text-xs font-bold uppercase tracking-widest transition-colors shadow-lg shadow-gold-500/20">
                            Confirm Booking
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkInInput = document.getElementById('id_check_in_date');
        const checkOutInput = document.getElementById('id_check_out_date');
        const roomSelectContainer = document.getElementById('room-selection-container');
        const roomSelect = document.getElementById('selected_room');
        const availableCountSpan = document.getElementById('available-count');
        const pricePerNight = {{ room_type.price_per_night }};
        const totalAmountEl = document.getElementById('estimated-total');
        const currencySymbol = "{{ site_settings.currency_symbol }}";

        function checkAvailability() {
            const checkIn = checkInInput.value;
            const checkOut = checkOutInput.value;

            if (checkIn && checkOut) {
                // Calculate Total
                const start = new Date(checkIn);
                const end = new Date(checkOut);
                
                if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                     return; // Invalid dates
                }

                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                if (diffDays > 0) {
                    const total = diffDays * pricePerNight;
                    totalAmountEl.textContent = `${currencySymbol}${total.toLocaleString()}`;
                } else {
                    totalAmountEl.textContent = "Invalid Dates";
                }

                // Fetch Rooms
                fetch(`{% url 'check_room_availability' room_type.id %}?check_in=${checkIn}&check_out=${checkOut}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.rooms) {
                            roomSelect.innerHTML = '<option value="">Auto-assign best available room</option>';
                            
                            if (data.rooms.length > 0) {
                                data.rooms.forEach(room => {
                                    const option = document.createElement('option');
                                    option.value = room.id;
                                    option.textContent = `Room ${room.number} ${room.floor ? '- Floor ' + room.floor : ''}`;
                                    roomSelect.appendChild(option);
                                });
                                availableCountSpan.textContent = data.rooms.length;
                                if(roomSelectContainer) roomSelectContainer.classList.remove('hidden');
                            } else {
                                if(roomSelectContainer) roomSelectContainer.classList.add('hidden');
                                // Only alert if user explicitly changed dates, not on initial load if empty
                                // But here we want to inform them.
                                // alert('No rooms available for selected dates.'); 
                                totalAmountEl.textContent = "No Rooms Available";
                            }
                        } else if (data.error) {
                            console.error(data.error);
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        checkInInput.addEventListener('change', checkAvailability);
        checkOutInput.addEventListener('change', checkAvailability);
        checkInInput.addEventListener('input', checkAvailability); // Handle typing/clearing
        checkOutInput.addEventListener('input', checkAvailability);
        
        // Run immediately in case of pre-filled data
        checkAvailability();
    });
</script>

<style>
    @keyframes fade-in-up {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up { animation: fade-in-up 1s ease-out forwards; opacity: 0; }
    .delay-100 { animation-delay: 0.2s; }
    .delay-200 { animation-delay: 0.4s; }
    .delay-300 { animation-delay: 0.6s; }
</style>
{% endblock %}
