{% extends 'dashboard_base.html' %}
{% load widget_tweaks %}

{% block header_title %}Add Room Type{% endblock %}
{% block header_subtitle %}Define a new category of rooms{% endblock %}

{% block dashboard_content %}
<div class="max-w-4xl mx-auto">
    <!-- Progress Steps -->
    <div class="mb-8">
        <div class="flex items-center justify-between relative">
            <div class="absolute left-0 top-1/2 -translate-y-1/2 w-full h-1 bg-border-dark -z-10"></div>
            <div class="flex items-center justify-center w-10 h-10 rounded-full bg-primary text-slate-900 font-bold transition-colors step-indicator" data-step="1">1</div>
            <div class="flex items-center justify-center w-10 h-10 rounded-full bg-border-dark text-text-secondary-dark font-bold transition-colors step-indicator" data-step="2">2</div>
        </div>
        <div class="flex justify-between mt-2 text-xs font-medium text-text-secondary-dark">
            <span>Basic Info</span>
            <span>Images</span>
        </div>
    </div>

    <form class="bg-surface-dark p-8 rounded-2xl border border-border-dark shadow-sm" method="POST" enctype="multipart/form-data" id="roomTypeForm">
        {% csrf_token %}
        
        <!-- Step 1: Basic Info -->
        <div class="step-content" data-step="1">
            <h3 class="text-lg font-bold text-text-main mb-6">Basic Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-text-main mb-2">Name</label>
                    {% render_field form.name class="w-full bg-background-dark border border-border-dark rounded-lg px-4 py-2.5 text-text-main focus:ring-2 focus:ring-primary focus:border-transparent text-sm" placeholder="e.g. Deluxe Suite" %}
                    {{ form.name.errors }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-text-main mb-2">Price per Night ({{ site_settings.currency_symbol }})</label>
                    {% render_field form.price_per_night class="w-full bg-background-dark border border-border-dark rounded-lg px-4 py-2.5 text-text-main focus:ring-2 focus:ring-primary focus:border-transparent text-sm" placeholder="0.00" %}
                    {{ form.price_per_night.errors }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-text-main mb-2">Capacity (Persons)</label>
                    {% render_field form.capacity class="w-full bg-background-dark border border-border-dark rounded-lg px-4 py-2.5 text-text-main focus:ring-2 focus:ring-primary focus:border-transparent text-sm" placeholder="2" %}
                    {{ form.capacity.errors }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-text-main mb-2">Total Rooms</label>
                    {% render_field form.number_of_rooms class="w-full bg-background-dark border border-border-dark rounded-lg px-4 py-2.5 text-text-main focus:ring-2 focus:ring-primary focus:border-transparent text-sm" placeholder="10" %}
                    {{ form.number_of_rooms.errors }}
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-text-main mb-2">Description</label>
                    {% render_field form.description class="w-full bg-background-dark border border-border-dark rounded-lg px-4 py-2.5 text-text-main focus:ring-2 focus:ring-primary focus:border-transparent text-sm" rows="3" %}
                    {{ form.description.errors }}
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-text-main mb-2">Amenities</label>
                    {% render_field form.amenities class="w-full bg-background-dark border border-border-dark rounded-lg px-4 py-2.5 text-text-main focus:ring-2 focus:ring-primary focus:border-transparent text-sm" placeholder="WiFi, AC, TV, etc." %}
                    <p class="mt-1 text-xs text-text-secondary-dark">Separate amenities with commas</p>
                    {{ form.amenities.errors }}
                </div>
            </div>
            <div class="mt-8 flex justify-end">
                <button type="button" class="btn-next px-6 py-2.5 bg-primary text-slate-900 font-bold rounded-lg hover:bg-primary-hover transition-colors">
                    Next Step
                </button>
            </div>
        </div>

        <!-- Step 2: Images -->
        <div class="step-content hidden" data-step="2">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-6">Room Images</h3>
            
            <div class="space-y-6">
                <!-- Main Image -->
                <div>
                    <label class="block text-sm font-medium text-slate-900 dark:text-white mb-2">Main Cover Image</label>
                    <div class="relative group cursor-pointer border-2 border-dashed border-border-light dark:border-border-dark rounded-xl p-8 text-center hover:border-primary transition-colors bg-gray-50 dark:bg-[#1A2C23]" onclick="document.getElementById('id_image').click()">
                        <input type="file" name="image" id="id_image" class="hidden" accept="image/*" onchange="previewImage(this, 'main-preview')">
                        <div id="main-preview" class="hidden w-full h-48 bg-cover bg-center rounded-lg mb-4"></div>
                        <div class="text-text-secondary-light dark:text-text-secondary-dark">
                            <span class="material-symbols-outlined text-4xl mb-2">add_photo_alternate</span>
                            <p class="text-sm">Click to upload main image</p>
                        </div>
                    </div>
                </div>

                <!-- Gallery Images -->
                <div>
                    <label class="block text-sm font-medium text-slate-900 dark:text-white mb-2">Gallery Images (Multiple)</label>
                    <div class="relative group cursor-pointer border-2 border-dashed border-border-light dark:border-border-dark rounded-xl p-8 text-center hover:border-primary transition-colors bg-gray-50 dark:bg-[#1A2C23]" onclick="document.getElementById('gallery_images').click()">
                        <input type="file" name="gallery_images" id="gallery_images" class="hidden" accept="image/*" multiple onchange="previewGallery(this)">
                        <div id="gallery-preview" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 empty:hidden"></div>
                        <div class="text-text-secondary-light dark:text-text-secondary-dark">
                            <span class="material-symbols-outlined text-4xl mb-2">collections</span>
                            <p class="text-sm">Click to upload multiple images</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-between">
                <button type="button" class="btn-prev px-6 py-2.5 border border-border-light dark:border-border-dark text-slate-900 dark:text-white font-medium rounded-lg hover:bg-gray-50 dark:hover:bg-[#234833] transition-colors">
                    Back
                </button>
                <button type="submit" class="px-6 py-2.5 bg-primary text-slate-900 font-bold rounded-lg hover:bg-primary-hover transition-colors shadow-lg shadow-primary/20">
                    Create Room Type
                </button>
            </div>
        </div>
    </form>
</div>

<script>
    // Multi-step Logic
    const steps = document.querySelectorAll('.step-content');
    const indicators = document.querySelectorAll('.step-indicator');
    const nextBtn = document.querySelector('.btn-next');
    const prevBtn = document.querySelector('.btn-prev');

    nextBtn.addEventListener('click', () => {
        // Validation for Step 1
        const step1Inputs = steps[0].querySelectorAll('input, textarea');
        let isValid = true;
        
        step1Inputs.forEach(input => {
            if (!input.checkValidity()) {
                isValid = false;
                input.reportValidity();
            }
        });

        if (isValid) {
            steps[0].classList.add('hidden');
            steps[1].classList.remove('hidden');
            updateIndicators(2);
        }
    });

    prevBtn.addEventListener('click', () => {
        steps[1].classList.add('hidden');
        steps[0].classList.remove('hidden');
        updateIndicators(1);
    });

    function updateIndicators(step) {
        indicators.forEach((ind, index) => {
            if (index + 1 <= step) {
                ind.classList.add('bg-primary', 'text-slate-900');
                ind.classList.remove('bg-border-dark', 'text-text-secondary-dark');
            } else {
                ind.classList.remove('bg-primary', 'text-slate-900');
                ind.classList.add('bg-border-dark', 'text-text-secondary-dark');
            }
        });
    }

    // Image Preview Logic
    function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.style.backgroundImage = `url('${e.target.result}')`;
                preview.classList.remove('hidden');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function previewGallery(input) {
        const container = document.getElementById('gallery-preview');
        container.innerHTML = ''; // Clear previous previews
        
        if (input.files) {
            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'h-24 bg-cover bg-center rounded-lg border border-border-dark';
                    div.style.backgroundImage = `url('${e.target.result}')`;
                    container.appendChild(div);
                }
                reader.readAsDataURL(file);
            });
        }
    }
</script>
{% endblock %}