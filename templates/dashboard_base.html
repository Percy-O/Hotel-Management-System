{% extends 'base_layout.html' %}
{% load static %}

{% block body_content %}
<div class="flex h-screen w-full overflow-hidden bg-background-dark">
    <!-- Sidebar -->
    {% include 'includes/sidebar.html' %}

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        <!-- Header -->
        <header class="flex items-center justify-between border-b border-border-dark bg-surface-dark px-6 py-4 sticky top-0 z-20">
            <div class="flex items-center gap-4">
                <button id="mobile-sidebar-toggle" class="lg:hidden text-text-main">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <div>
                    <h2 class="text-text-main text-xl font-bold leading-tight">{% block header_title %}Dashboard{% endblock %}</h2>
                    <p class="text-text-secondary-dark text-xs">{% block header_subtitle %}Overview{% endblock %}</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <!-- Tenant Switcher -->
                {% if user.is_authenticated %}
                <div class="relative group mr-4">
                    <button class="flex items-center gap-2 text-text-main hover:bg-white/5 p-2 rounded-lg transition-colors">
                        <span class="material-symbols-outlined text-primary">apartment</span>
                        <span class="font-semibold hidden sm:inline">{{ request.tenant.name|default:"Select Hotel" }}</span>
                        <span class="material-symbols-outlined text-sm">expand_more</span>
                    </button>
                    <div class="absolute right-0 top-full mt-2 w-56 bg-surface-dark/95 backdrop-blur-xl border border-border-dark rounded-xl shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 transform origin-top-right scale-95 group-hover:scale-100">
                        <div class="py-2">
                            <p class="px-4 py-2 text-xs font-semibold text-text-secondary-dark uppercase tracking-wider">Switch Organization</p>
                            {% for membership in user.memberships.all %}
                            <a href="//{{ membership.tenant.domains.first.domain|default:membership.tenant.subdomain }}.localhost:8000" class="flex items-center gap-3 px-4 py-3 text-sm text-text-secondary-dark hover:text-white hover:bg-primary/10 transition-colors {% if membership.tenant == request.tenant %}bg-primary/5 text-primary{% endif %}">
                                <div class="w-2 h-2 rounded-full {% if membership.tenant == request.tenant %}bg-primary{% else %}bg-gray-600{% endif %}"></div>
                                {{ membership.tenant.name }}
                            </a>
                            {% endfor %}
                            <div class="border-t border-border-dark my-1"></div>
                            <a href="#" class="flex items-center gap-2 px-4 py-2 text-sm text-primary hover:text-primary-hover hover:bg-primary/5 transition-colors">
                                <span class="material-symbols-outlined text-lg">add</span>
                                Create New Hotel
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% block header_actions %}{% endblock %}
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-6">
            {% block dashboard_content %}{% endblock %}

            <!-- Footer -->
            <div class="mt-8 pt-6 border-t border-border-dark flex flex-col items-center justify-center gap-2">
                <p class="text-sm text-text-secondary-dark font-medium flex items-center gap-1">
                    Powered by 
                    <a href="https://techohr.com.ng" target="_blank" class="text-primary hover:underline font-bold">TechOhr</a>
                </p>
                <p class="text-xs text-text-secondary-dark opacity-70">
                    &copy; {% now "Y" %} {{ site_settings.hotel_name }}
                </p>
            </div>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const toggleBtn = document.getElementById('mobile-sidebar-toggle');
        const sidebar = document.querySelector('aside');
        
        if (!toggleBtn || !sidebar) return;

        function getOrCreateOverlay() {
            let overlay = document.getElementById('sidebar-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'sidebar-overlay';
                overlay.className = 'fixed inset-0 bg-black/50 z-30 hidden lg:hidden transition-opacity duration-300 opacity-0';
                document.body.appendChild(overlay);
                overlay.addEventListener('click', closeSidebar);
            }
            return overlay;
        }

        function openSidebar() {
            const overlay = getOrCreateOverlay();
            sidebar.classList.remove('hidden');
            sidebar.classList.add('fixed', 'inset-y-0', 'left-0', 'z-40', 'w-64', 'bg-surface-dark', 'shadow-2xl', 'transform', 'transition-transform', 'duration-300', '-translate-x-full');
            // Small delay to allow transition to work
            requestAnimationFrame(() => {
                sidebar.classList.remove('-translate-x-full');
            });
            
            overlay.classList.remove('hidden');
            overlay.style.display = 'block';
            // Small delay for fade in
            requestAnimationFrame(() => {
                overlay.classList.remove('opacity-0');
            });
        }

        function closeSidebar() {
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.add('-translate-x-full');
            if (overlay) overlay.classList.add('opacity-0');
            
            setTimeout(() => {
                sidebar.classList.add('hidden');
                sidebar.classList.remove('fixed', 'inset-y-0', 'left-0', 'z-40', 'shadow-2xl', 'transform', 'transition-transform', 'duration-300');
                if (overlay) {
                    overlay.classList.add('hidden');
                    overlay.style.display = 'none';
                }
            }, 300);
        }

        toggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openSidebar();
        });

        // Close on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !sidebar.classList.contains('hidden')) {
                closeSidebar();
            }
        });
    });
</script>

<!-- Global Barcode Scanner Listener -->
<script>
    (function() {
        let buffer = "";
        let lastKeyTime = Date.now();
        const SCAN_TIMEOUT = 100; // ms between keys for it to be considered a scan
        const MIN_LENGTH = 3; // Minimum length of a barcode
        
        document.addEventListener('keydown', (e) => {
            const currentTime = Date.now();
            const target = e.target;
            
            // Ignore if user is typing in an input field (unless we want to force redirect, but usually bad UX)
            if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable) {
                return;
            }
            
            // Calculate time since last keypress
            const timeDiff = currentTime - lastKeyTime;
            lastKeyTime = currentTime;
            
            // If time difference is too large, reset buffer (it's manual typing)
            if (timeDiff > SCAN_TIMEOUT) {
                buffer = "";
            }
            
            if (e.key === 'Enter') {
                // Check if buffer contains a valid scan code
                if (buffer.length >= MIN_LENGTH) {
                    // Logic to detect if it's a barcode
                    // Simple check: assume anything scanned rapidly ending in Enter is a barcode
                    console.log("Global Scanner Detected:", buffer);
                    
                    // Redirect to verify page
                    const verifyUrl = "{% url 'verify_booking' %}";
                    window.location.href = `${verifyUrl}?code=${encodeURIComponent(buffer)}`;
                    
                    // Prevent default Enter behavior (like form submission if any)
                    e.preventDefault();
                }
                buffer = "";
            } else if (e.key.length === 1) {
                // Add printable characters to buffer
                buffer += e.key;
            }
        });
    })();
</script>
{% endblock %}