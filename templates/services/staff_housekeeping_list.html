{% extends 'dashboard_base.html' %}
{% load static %}

{% block header_title %}Housekeeping Management{% endblock %}
{% block header_subtitle %}Manage guest cleaning and maintenance requests{% endblock %}

{% block dashboard_content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Active Requests -->
    <div class="lg:col-span-2 space-y-6">
        <div class="bg-surface-dark border border-border-dark rounded-xl overflow-hidden">
            <div class="p-4 border-b border-border-dark flex justify-between items-center">
                <h3 class="font-semibold text-text-main">Active Requests</h3>
                <span class="bg-primary/10 text-primary text-xs font-medium px-2.5 py-0.5 rounded-full">{{ requests.count }} Pending</span>
            </div>
            
            <div class="divide-y divide-border-dark">
                {% for req in requests %}
                <div class="p-4 hover:bg-white/5 transition-colors">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-3">
                            <span class="px-2 py-1 bg-background-dark rounded text-xs font-bold text-text-main border border-border-dark">
                                Room {{ req.room_number }}
                            </span>
                            <div class="flex flex-col">
                                <h4 class="font-medium text-text-main">{{ req.get_request_type_display }}</h4>
                                {% if req.request_id %}<span class="text-[10px] font-mono text-text-secondary-dark">#{{ req.request_id }}</span>{% endif %}
                            </div>
                        </div>
                        <span class="px-2 py-1 rounded-full text-xs font-medium 
                            {% if req.status == 'PENDING' %}bg-yellow-500/10 text-yellow-500
                            {% elif req.status == 'IN_PROGRESS' %}bg-blue-500/10 text-blue-500
                            {% else %}bg-green-500/10 text-green-500{% endif %}">
                            {{ req.get_status_display }}
                        </span>
                    </div>
                    
                    {% if req.note %}
                    <p class="text-sm text-text-secondary-dark mb-3 bg-background-dark/50 p-2 rounded border border-border-dark/50">
                        "{{ req.note }}"
                    </p>
                    {% endif %}
                    
                    <div class="flex items-center justify-between mt-3">
                        <div class="text-xs text-text-secondary-dark flex items-center gap-2">
                            <span class="material-symbols-outlined text-[16px]">schedule</span>
                            {{ req.created_at|timesince }} ago
                        </div>
                        
                        <div class="flex items-center gap-2">
                            {% if req.status == 'PENDING' %}
                            <form method="post" action="{% url 'update_housekeeping_status' req.pk %}">
                                {% csrf_token %}
                                <button type="submit" name="assign_me" class="px-3 py-1.5 bg-primary/10 text-primary hover:bg-primary hover:text-white rounded text-xs font-medium transition-colors">
                                    Assign to Me
                                </button>
                            </form>
                            {% elif req.assigned_staff == request.user %}
                            <form method="post" action="{% url 'update_housekeeping_status' req.pk %}" class="flex items-center gap-2">
                                {% csrf_token %}
                                <select name="status" class="bg-background-dark border border-border-dark rounded px-2 py-1 text-xs text-text-main outline-none focus:border-primary">
                                    {% for code, label in status_choices %}
                                        <option value="{{ code }}" {% if req.status == code %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <button type="submit" class="px-3 py-1.5 bg-surface-dark border border-border-dark text-text-main hover:bg-white/5 rounded text-xs font-medium transition-colors">
                                    Update
                                </button>
                            </form>
                            {% else %}
                                <span class="text-xs text-text-secondary-dark flex items-center gap-1">
                                    <span class="material-symbols-outlined text-[16px]">person</span>
                                    {{ req.assigned_staff.get_full_name|default:req.assigned_staff.username }}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="p-8 text-center text-text-secondary-dark">
                    <span class="material-symbols-outlined text-4xl mb-2 opacity-50">check_circle</span>
                    <p>No active requests pending.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- My Tasks -->
    <div class="space-y-6">
        <div class="bg-surface-dark border border-border-dark rounded-xl p-4">
            <h3 class="font-semibold text-text-main mb-4">My Tasks</h3>
            <div class="space-y-3">
                {% for task in my_tasks %}
                <div class="p-3 bg-background-dark rounded-lg border border-border-dark">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-sm font-medium text-text-main">Room {{ task.room_number }}</span>
                        <span class="text-xs text-blue-400">{{ task.get_request_type_display }}</span>
                    </div>
                    <form method="post" action="{% url 'update_housekeeping_status' task.pk %}" class="mt-2">
                        {% csrf_token %}
                        <div class="flex gap-2">
                            <button type="submit" name="status" value="COMPLETED" class="flex-1 py-1.5 bg-green-500/10 text-green-500 hover:bg-green-500 hover:text-white rounded text-xs font-medium transition-colors">
                                Complete
                            </button>
                            <button type="submit" name="status" value="CANCELLED" class="px-3 py-1.5 bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white rounded text-xs font-medium transition-colors">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
                {% empty %}
                <p class="text-sm text-text-secondary-dark text-center py-4">You have no assigned tasks.</p>
                {% endfor %}
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="bg-gradient-to-br from-primary/20 to-surface-dark border border-primary/20 rounded-xl p-6">
            <h3 class="font-semibold text-text-main mb-1">Shift Overview</h3>
            <p class="text-sm text-text-secondary-dark mb-4">Your activity today</p>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-surface-dark/50 rounded-lg p-3 text-center">
                    <span class="block text-2xl font-bold text-primary">{{ my_tasks.count }}</span>
                    <span class="text-xs text-text-secondary-dark">Pending</span>
                </div>
                <div class="bg-surface-dark/50 rounded-lg p-3 text-center">
                    <span class="block text-2xl font-bold text-green-500">--</span>
                    <span class="text-xs text-text-secondary-dark">Completed</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
